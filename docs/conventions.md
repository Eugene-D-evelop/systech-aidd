# Соглашения по разработке кода

> **Полное техническое видение:** [vision.md](vision.md)

## Принципы (KISS)

1. **Максимальная простота** - прямолинейный код без избыточных абстракций
2. **1 класс = 1 файл** - четкая структура, понятная навигация
3. **Async/await** - асинхронность для всех I/O операций (Telegram, LLM API)
4. **Явное лучше неявного** - понятные имена, читаемый код

## Технологии

- **Python 3.11+**, **uv** (управление зависимостями)
- **aiogram 3.x** (Telegram Bot API, polling)
- **openai** SDK (работа с OpenRouter)
- **pydantic** (валидация конфигурации)
- **ruff** (линтинг и форматирование)

## Структура проекта

```
src/
├── main.py           # Точка входа
├── config.py         # Config (Pydantic BaseSettings)
├── bot.py            # TelegramBot
├── handlers.py       # MessageHandler
├── llm_client.py     # LLMClient
└── conversation.py   # Conversation (in-memory)
```

## Антипаттерны (НЕ делать)

- ❌ Сложные паттерны проектирования (фабрики, стратегии)
- ❌ Множественные уровни абстракции
- ❌ Преждевременная оптимизация
- ❌ Базы данных (используем in-memory хранение)
- ❌ Retry, streaming, кеширование (пока не нужно)

## Правила кода

### Именование
- Классы: `ПаскальСтиль` (TelegramBot, LLMClient)
- Функции/методы: `snake_case` (get_response, add_message)
- Приватные: префикс `_` (только если действительно внутреннее)

### Типизация
- Используйте type hints везде: `def method(param: str) -> dict`
- Для словарей: `dict[str, list[dict]]`

### Асинхронность
- Все I/O операции: `async def`, `await`
- HTTP запросы: через `aiohttp` или `openai` SDK async методы

### Обработка ошибок
- Ловите конкретные исключения (Timeout, APIError, NetworkError)
- Возвращайте понятные сообщения пользователю
- Логируйте ошибки уровня ERROR с трейсбеком

### Конфигурация
- Все настройки через `.env` файл
- Класс Config использует Pydantic BaseSettings
- Валидация при старте приложения

### Логирование
- Стандартный модуль `logging`
- INFO: старт бота, получение/отправка сообщений, команды
- ERROR: ошибки API, timeout, исключения
- НЕ логируем: полные тексты сообщений, API ключи

## Модель данных

### Message (простой dict)
```python
{
    "role": str,        # "user" | "assistant" | "system"
    "content": str,
    "timestamp": float  # time.time()
}
```

### Conversation Storage
```python
conversations: dict[str, list[dict]]
# Ключ: "chat_id:user_id"
# Значение: список сообщений
```

## Качество кода

- **Читаемость > краткость**: явный код важнее компактного
- **Без магии**: никаких скрытых зависимостей или неявных импортов
- **Один метод = одна ответственность**
- **Минимальная вложенность**: избегайте глубоких if/try
- **Ruff проверка**: код должен проходить линтер без ошибок

## Тестирование

- Юнит-тесты для каждого класса (pytest)
- Моки для внешних API (Telegram, OpenRouter)
- Async тесты: используйте pytest-asyncio

---

**При генерации кода следуйте этим правилам строго. Подробности архитектуры и сценариев см. в [vision.md](vision.md)**

