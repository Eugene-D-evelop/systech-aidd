# üé® –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ü—Ä–æ–µ–∫—Ç–∞

> **–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ systech-aidd —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º**

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (C4 Context)](#1-–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è-–¥–∏–∞–≥—Ä–∞–º–º–∞-c4-context)
2. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#2-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤](#3-–¥–∏–∞–≥—Ä–∞–º–º–∞-–∫–ª–∞—Å—Å–æ–≤)
4. [–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#4-–¥–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏-sequence)
5. [–î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π](#5-–¥–∏–∞–≥—Ä–∞–º–º–∞-—Å–æ—Å—Ç–æ—è–Ω–∏–π-state)
6. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Data Flow)](#6-–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö-data-flow)
7. [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏—è](#7-–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª-—Å–æ–æ–±—â–µ–Ω–∏—è)
8. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#8-–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫-error-handling)
9. [User Journey (–ü—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)](#9-user-journey-–ø—É—Ç—å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
10. [Deployment Architecture](#10-deployment-architecture)
11. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö](#11-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ö—Ä–∞–Ω–µ–Ω–∏—è-–¥–∞–Ω–Ω—ã—Ö)
12. [CI/CD Pipeline](#12-cicd-pipeline)

---

## 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (C4 Context)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** –í–Ω–µ—à–Ω–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å - –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –≤–Ω–µ—à–Ω–∏–º –º–∏—Ä–æ–º

```mermaid
graph TB
    User[üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å<br/>Telegram User]:::userStyle
    Bot[ü§ñ Systech-AIDD Bot<br/>Python Code Reviewer]:::systemStyle
    TelegramAPI[üì± Telegram API<br/>Bot API]:::externalStyle
    OpenRouter[üß† OpenRouter API<br/>LLM Gateway]:::externalStyle
    LLM[üéØ LLM Model<br/>GPT/Claude/etc]:::externalStyle

    User -->|"–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥<br/>–Ω–∞ —Ä–µ–≤—å—é"| Bot
    Bot -->|"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç<br/>–∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞"| User
    Bot <-->|"Polling/Webhooks<br/>aiogram"| TelegramAPI
    Bot <-->|"Chat Completions<br/>OpenAI SDK"| OpenRouter
    OpenRouter <-->|"–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è<br/>–∑–∞–ø—Ä–æ—Å–æ–≤"| LLM

    classDef userStyle fill:#FF6B6B,stroke:#C92A2A,stroke-width:3px,color:#FFF
    classDef systemStyle fill:#4ECDC4,stroke:#0A7C74,stroke-width:4px,color:#FFF
    classDef externalStyle fill:#95E1D3,stroke:#38A98F,stroke-width:2px,color:#000
```

### –û–ø–∏—Å–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π:
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Bot**: –û—Ç–ø—Ä–∞–≤–∫–∞ Python –∫–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ Telegram
- **Bot ‚Üî Telegram API**: –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ polling (aiogram)
- **Bot ‚Üî OpenRouter**: HTTP –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ OpenAI SDK
- **OpenRouter ‚Üî LLM**: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º

---

## 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```mermaid
graph TB
    subgraph "üéØ Entry Point"
        Main[main.py<br/>Entry Point]:::entryStyle
    end

    subgraph "‚öôÔ∏è Configuration Layer"
        Config[config.py<br/>Pydantic Settings]:::configStyle
        Env[.env<br/>Environment Variables]:::configStyle
    end

    subgraph "ü§ñ Telegram Layer"
        Bot[bot.py<br/>TelegramBot]:::telegramStyle
        Handlers[handlers.py<br/>MessageHandler]:::telegramStyle
    end

    subgraph "üß† Business Logic Layer"
        LLMClient[llm_client.py<br/>LLMClient]:::logicStyle
        Conversation[conversation.py<br/>Conversation]:::logicStyle
    end

    subgraph "üåê External Services"
        TG_API[Telegram Bot API]:::externalStyle
        OR_API[OpenRouter API]:::externalStyle
    end

    Main --> Config
    Main --> Bot
    Main --> Handlers
    Main --> LLMClient
    Main --> Conversation
    
    Config -.->|load| Env
    Bot --> Config
    Bot --> Handlers
    
    Handlers --> Config
    Handlers --> LLMClient
    Handlers --> Conversation
    
    LLMClient --> Config
    LLMClient --> OR_API
    
    Bot --> TG_API
    Handlers --> TG_API

    classDef entryStyle fill:#FFD93D,stroke:#F4A900,stroke-width:4px,color:#000
    classDef configStyle fill:#6BCB77,stroke:#2F9E44,stroke-width:3px,color:#FFF
    classDef telegramStyle fill:#4D96FF,stroke:#1E5A9E,stroke-width:3px,color:#FFF
    classDef logicStyle fill:#9B59B6,stroke:#6C3483,stroke-width:3px,color:#FFF
    classDef externalStyle fill:#E74C3C,stroke:#C0392B,stroke-width:2px,color:#FFF
```

### –°–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- **Entry Point**: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- **Configuration**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Pydantic
- **Telegram Layer**: –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram Bot API
- **Business Logic**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ LLM –∑–∞–ø—Ä–æ—Å–æ–≤
- **External Services**: –í–Ω–µ—à–Ω–∏–µ API

---

## 3. –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è

```mermaid
classDiagram
    class Config {
        +str telegram_bot_token
        +str openrouter_api_key
        +str openrouter_model
        +str system_prompt
        +int max_history_length
        +float temperature
        +int max_tokens
        +int timeout
    }

    class TelegramBot {
        -Config config
        -Bot bot
        -Dispatcher dp
        +__init__(config: Config)
        +register_handlers(handler: MessageHandler)
        +start() async
    }

    class MessageHandler {
        -Config config
        -LLMClient llm_client
        -Conversation conversation
        +__init__(config, llm_client, conversation)
        +start_command(message: Message) async
        +role_command(message: Message) async
        +reset_command(message: Message) async
        +handle_message(message: Message) async
    }

    class LLMClient {
        -Config config
        -AsyncOpenAI client
        +__init__(config: Config)
        +get_response(messages: list, system_prompt: str) async str
        +test_connection() async bool
    }

    class Conversation {
        -dict~str, list~ conversations
        +add_message(chat_id, user_id, role, content)
        +get_history(chat_id, user_id, limit) list
        +clear_history(chat_id, user_id)
        +get_stats() dict
        -_get_user_key(chat_id, user_id) str
    }

    class LLMError {
        <<exception>>
    }

    TelegramBot --> Config : uses
    TelegramBot --> MessageHandler : registers
    MessageHandler --> Config : uses
    MessageHandler --> LLMClient : uses
    MessageHandler --> Conversation : uses
    LLMClient --> Config : uses
    LLMClient --> LLMError : raises

    style Config fill:#F39C12,stroke:#D68910,stroke-width:3px,color:#FFF
    style TelegramBot fill:#3498DB,stroke:#2874A6,stroke-width:3px,color:#FFF
    style MessageHandler fill:#E74C3C,stroke:#C0392B,stroke-width:3px,color:#FFF
    style LLMClient fill:#9B59B6,stroke:#7D3C98,stroke-width:3px,color:#FFF
    style Conversation fill:#1ABC9C,stroke:#148F77,stroke-width:3px,color:#FFF
    style LLMError fill:#E67E22,stroke:#CA6F1E,stroke-width:2px,color:#FFF
```

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **Single Responsibility**: –ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- **Dependency Injection**: Config –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã
- **Composition over Inheritance**: –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤–º–µ—Å—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

---

## 4. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Sequence)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ - –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–∏

```mermaid
sequenceDiagram
    autonumber
    actor User as üë§ User
    participant TG as üì± Telegram API
    participant Bot as ü§ñ Bot
    participant Handler as üéØ MessageHandler
    participant Conv as üíæ Conversation
    participant LLM as üß† LLMClient
    participant OR as üåê OpenRouter

    User->>TG: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º
    TG->>Bot: Update (polling)
    Bot->>Handler: handle_message(message)
    
    rect rgb(255, 230, 200)
        Note over Handler,Conv: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        Handler->>Conv: add_message(chat_id, user_id, "user", text)
        Handler->>Conv: get_history(chat_id, user_id, limit=10)
        Conv-->>Handler: history: list[dict]
    end
    
    Handler->>TG: send_chat_action("typing")
    
    rect rgb(200, 230, 255)
        Note over Handler,OR: LLM Processing
        Handler->>LLM: get_response(messages, system_prompt)
        LLM->>OR: chat.completions.create(model, messages)
        OR-->>LLM: completion response
        LLM-->>Handler: answer: str
    end
    
    rect rgb(200, 255, 230)
        Note over Handler,User: –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        Handler->>Conv: add_message(chat_id, user_id, "assistant", answer)
        Handler->>TG: answer(response_text)
        TG->>User: –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
    end

    Note over User,OR: ‚úÖ –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
```

### –ö–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã:
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è**: Telegram API ‚Üí Bot ‚Üí Handler
2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é + –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. **LLM Processing**: –ó–∞–ø—Ä–æ—Å –∫ OpenRouter –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
4. **–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é + –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram

---

## 5. –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (State)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** –ê–Ω–∞–ª–∏—Ç–∏–∫ - –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–∏–∞–ª–æ–≥–∞

```mermaid
stateDiagram-v2
    [*] --> NoHistory: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    
    NoHistory --> Active: /start –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    
    state Active {
        [*] --> WaitingUserMessage
        WaitingUserMessage --> ProcessingLLM: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        ProcessingLLM --> SendingResponse: LLM –æ—Ç–≤–µ—Ç–∏–ª
        SendingResponse --> WaitingUserMessage: –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        
        ProcessingLLM --> ErrorHandling: Timeout/APIError
        ErrorHandling --> WaitingUserMessage: –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    }
    
    Active --> HistoryFull: history.length >= max_history_length
    HistoryFull --> Active: –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    
    Active --> Reset: /reset –∫–æ–º–∞–Ω–¥–∞
    Reset --> NoHistory: –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞
    
    Active --> ShowingRole: /role –∫–æ–º–∞–Ω–¥–∞
    ShowingRole --> Active: –ü–æ–∫–∞–∑–∞–Ω–∞ —Ä–æ–ª—å
    
    NoHistory --> [*]: –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
    Active --> [*]: –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
    HistoryFull --> [*]: –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

    note right of NoHistory
        In-memory storage
        –ü–æ—Ç–µ—Ä—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
    end note

    note right of ProcessingLLM
        –¢–∞–π–º–∞—É—Ç: 60 —Å–µ–∫
        Retry: –Ω–µ—Ç
    end note

    note right of HistoryFull
        –õ–∏–º–∏—Ç: 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö
    end note
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:
- **NoHistory**: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏
- **Active**: –ê–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **ProcessingLLM**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM
- **ErrorHandling**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
- **HistoryFull**: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∏—Å—Ç–æ—Ä–∏–∏
- **Reset**: –°–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- **ShowingRole**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–æ–ª–∏ –±–æ—Ç–∞

---

## 6. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** Data Engineer - –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ

```mermaid
graph LR
    subgraph "üì• INPUT"
        A[User Message<br/>plain text]:::inputStyle
    end

    subgraph "üîÑ TRANSFORMATION"
        B[Message Object<br/>aiogram.types.Message]:::transformStyle
        C[Message Dict<br/>role: user<br/>content: text<br/>timestamp: float]:::transformStyle
        D[History Array<br/>list of messages]:::transformStyle
        E[API Request<br/>OpenAI format<br/>no timestamp]:::transformStyle
    end

    subgraph "üß† PROCESSING"
        F[LLM Response<br/>raw completion]:::processStyle
        G[Response String<br/>extracted text]:::processStyle
    end

    subgraph "üíæ STORAGE"
        H[In-Memory Store<br/>conversations dict]:::storageStyle
        I[User Key<br/>chat_id:user_id]:::storageStyle
    end

    subgraph "üì§ OUTPUT"
        J[Telegram Message<br/>HTML formatted]:::outputStyle
    end

    A --> B
    B --> C
    C --> I
    I --> H
    H --> D
    D --> E
    E --> F
    F --> G
    G --> I
    I --> H
    G --> J

    classDef inputStyle fill:#FF6B6B,stroke:#E03131,stroke-width:3px,color:#FFF
    classDef transformStyle fill:#4DABF7,stroke:#1971C2,stroke-width:2px,color:#FFF
    classDef processStyle fill:#9775FA,stroke:#7048E8,stroke-width:3px,color:#FFF
    classDef storageStyle fill:#51CF66,stroke:#2F9E44,stroke-width:2px,color:#FFF
    classDef outputStyle fill:#FFD43B,stroke:#FAB005,stroke-width:3px,color:#000
```

### –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
1. **Input**: –¢–µ–∫—Å—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **Message Object**: aiogram Message —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
3. **Message Dict**: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å role/content/timestamp
4. **Storage**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ in-memory —Å–ª–æ–≤–∞—Ä—å
5. **History Array**: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
6. **API Request**: –§–æ—Ä–º–∞—Ç OpenAI (–±–µ–∑ timestamp)
7. **LLM Response**: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏
8. **Output**: HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

---

## 7. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–æ–æ–±—â–µ–Ω–∏—è

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** DevOps - –ø—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É

```mermaid
journey
    title –ü—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É
    section –ü–æ–ª—É—á–µ–Ω–∏–µ
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥: 5: User
      Telegram –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: 5: Telegram
      Bot polling –ø–æ–ª—É—á–∞–µ—Ç Update: 4: Bot
      Dispatcher –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç: 4: Bot
    section –û–±—Ä–∞–±–æ—Ç–∫–∞
      Handler –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: 4: Handler
      –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ chat_id & user_id: 5: Handler
      –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é: 5: Conversation
      –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏: 4: Conversation
    section LLM –∑–∞–ø—Ä–æ—Å
      –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞: 4: LLMClient
      –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ OpenRouter: 3: LLMClient
      –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (timeout 60s): 2: OpenRouter
      –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞: 4: LLMClient
    section –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é: 5: Conversation
      –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram: 5: Handler
      –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Bot API: 4: Telegram
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Ç–≤–µ—Ç: 5: User
```

### –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- **–ü–æ–ª—É—á–µ–Ω–∏–µ**: 0-2 —Å–µ–∫ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç polling interval)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: < 100 –º—Å (in-memory –æ–ø–µ—Ä–∞—Ü–∏–∏)
- **LLM –∑–∞–ø—Ä–æ—Å**: 2-60 —Å–µ–∫ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–≥—Ä—É–∑–∫–∏)
- **–í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**: < 500 –º—Å

---

## 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (Error Handling)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** QA Engineer - –ø–æ—Ç–æ–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

```mermaid
graph TD
    Start[üöÄ –ó–∞–ø—Ä–æ—Å –∫ LLM]:::startStyle
    Request[LLMClient.get_response]:::normalStyle
    
    Success{‚úÖ –£—Å–ø–µ—Ö?}:::decisionStyle
    EmptyCheck{–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç?}:::decisionStyle
    
    Timeout[‚è±Ô∏è APITimeoutError]:::errorStyle
    APIErr[‚ùå APIError]:::errorStyle
    LLMErr[‚ö†Ô∏è LLMError]:::errorStyle
    UnexpErr[üí• Exception]:::errorStyle
    
    HandleTimeout[Handler: Timeout UI message]:::handlerStyle
    HandleAPI[Handler: API Error UI message]:::handlerStyle
    HandleLLM[Handler: LLM Error UI message]:::handlerStyle
    
    LogError[üìù Logger.error with traceback]:::logStyle
    
    UserMsg[üì± –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]:::outputStyle
    HistorySaved[üíæ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞]:::saveStyle
    End[üèÅ –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É]:::endStyle

    Start --> Request
    Request --> Success
    
    Success -->|Yes| EmptyCheck
    EmptyCheck -->|No| HistorySaved
    EmptyCheck -->|Yes| LLMErr
    
    Success -->|Timeout| Timeout
    Success -->|API Error| APIErr
    Success -->|Other Error| UnexpErr
    
    Timeout --> LogError
    APIErr --> LogError
    UnexpErr --> LLMErr
    LLMErr --> LogError
    
    LogError --> HandleTimeout
    LogError --> HandleAPI
    Timeout --> HandleTimeout
    APIErr --> HandleAPI
    LLMErr --> HandleLLM
    
    HandleTimeout --> UserMsg
    HandleAPI --> UserMsg
    HandleLLM --> UserMsg
    
    HistorySaved --> UserMsg
    UserMsg --> End

    classDef startStyle fill:#4ECDC4,stroke:#0A7C74,stroke-width:3px,color:#FFF
    classDef normalStyle fill:#95E1D3,stroke:#38A98F,stroke-width:2px,color:#000
    classDef decisionStyle fill:#FFE66D,stroke:#F4A900,stroke-width:3px,color:#000
    classDef errorStyle fill:#FF6B6B,stroke:#C92A2A,stroke-width:3px,color:#FFF
    classDef handlerStyle fill:#A8DADC,stroke:#457B9D,stroke-width:2px,color:#000
    classDef logStyle fill:#F1FAEE,stroke:#1D3557,stroke-width:2px,color:#000
    classDef outputStyle fill:#E63946,stroke:#A4161A,stroke-width:2px,color:#FFF
    classDef saveStyle fill:#06FFA5,stroke:#02C875,stroke-width:2px,color:#000
    classDef endStyle fill:#4ECDC4,stroke:#0A7C74,stroke-width:3px,color:#FFF
```

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞:

| –û—à–∏–±–∫–∞ | –ò—Å—Ç–æ—á–Ω–∏–∫ | –û–±—Ä–∞–±–æ—Ç—á–∏–∫ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|------------|----------|
| `APITimeoutError` | OpenRouter | MessageHandler | "‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (60—Å)" |
| `APIError` | OpenRouter | MessageHandler | "‚ùå –û—à–∏–±–∫–∞ API: {details}" |
| `LLMError` | LLMClient | MessageHandler | "‚ö†Ô∏è –û—à–∏–±–∫–∞ LLM: {details}" |
| `Exception` | –õ—é–±–æ–π | MessageHandler | "üí• –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞" |

---

## 9. User Journey (–ü—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** UX Designer - –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–æ–º

```mermaid
graph TD
    Start([üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –±–æ—Ç–∞]):::userStyle
    
    StartCmd[/start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ]:::cmdStyle
    Welcome["üëã –ü—Ä–∏–≤–µ—Ç! –Ø Python Code Reviewer<br/>üí° –ö–æ–º–∞–Ω–¥—ã: /role, /reset"]:::msgStyle
    
    Choice1{–ß—Ç–æ –¥–µ–ª–∞—Ç—å?}:::choiceStyle
    
    RoleCmd[/role - –£–∑–Ω–∞—Ç—å –æ —Ä–æ–ª–∏]:::cmdStyle
    RoleInfo["üé≠ –ú–æ—è —Ä–æ–ª—å: Python Code Reviewer<br/>üìã –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:<br/>‚Ä¢ PEP 8 –ø—Ä–æ–≤–µ—Ä–∫–∞<br/>‚Ä¢ –ü–æ–∏—Å–∫ –±–∞–≥–æ–≤<br/>‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É"]:::msgStyle
    
    SendCode[üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å Python –∫–æ–¥]:::actionStyle
    Typing[‚å®Ô∏è Bot typing...]:::processStyle
    Review["‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞:<br/>1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PEP 8<br/>2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏<br/>3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"]:::msgStyle
    
    Continue{–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?}:::choiceStyle
    
    MoreCode[üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â–µ –∫–æ–¥]:::actionStyle
    ResetCmd[/reset - –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥]:::cmdStyle
    ResetMsg["üîÑ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!"]:::msgStyle
    
    Exit([üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç]):::endStyle

    Start --> StartCmd
    StartCmd --> Welcome
    Welcome --> Choice1
    
    Choice1 -->|"–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ"| RoleCmd
    RoleCmd --> RoleInfo
    RoleInfo --> Choice1
    
    Choice1 -->|"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥"| SendCode
    SendCode --> Typing
    Typing --> Review
    Review --> Continue
    
    Continue -->|"–î–∞"| MoreCode
    MoreCode --> Typing
    
    Continue -->|"–°–±—Ä–æ—Å–∏—Ç—å"| ResetCmd
    ResetCmd --> ResetMsg
    ResetMsg --> Choice1
    
    Continue -->|"–í—ã—Ö–æ–¥"| Exit

    classDef userStyle fill:#FF6B6B,stroke:#C92A2A,stroke-width:4px,color:#FFF
    classDef cmdStyle fill:#4DABF7,stroke:#1971C2,stroke-width:3px,color:#FFF
    classDef msgStyle fill:#51CF66,stroke:#2F9E44,stroke-width:2px,color:#FFF
    classDef choiceStyle fill:#FFD43B,stroke:#FAB005,stroke-width:3px,color:#000
    classDef actionStyle fill:#9775FA,stroke:#7048E8,stroke-width:2px,color:#FFF
    classDef processStyle fill:#FFA94D,stroke:#FD7E14,stroke-width:2px,color:#FFF
    classDef endStyle fill:#868E96,stroke:#495057,stroke-width:3px,color:#FFF
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
1. **–û–Ω–±–æ—Ä–¥–∏–Ω–≥**: `/start` ‚Üí –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí `/role` ‚Üí –ü–æ–Ω–∏–º–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
2. **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É**: –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–≤—å—é ‚Üí –ü–æ–≤—Ç–æ—Ä
3. **–°–±—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: `/reset` ‚Üí –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥

---

## 10. Deployment Architecture

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** DevOps - —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```mermaid
graph TB
    subgraph "üñ•Ô∏è Local Development"
        Dev[Developer Machine]:::devStyle
        LocalEnv[.env file<br/>Local config]:::configStyle
        UVEnv[uv venv<br/>Python 3.11+]:::envStyle
    end

    subgraph "üîß Development Tools"
        Make[Makefile<br/>Tasks automation]:::toolStyle
        Ruff[Ruff<br/>Linting & Format]:::toolStyle
        Mypy[Mypy<br/>Type checking]:::toolStyle
        Pytest[Pytest<br/>Testing]:::toolStyle
    end

    subgraph "üê≥ Production Environment"
        Container[Docker Container<br/>Optional]:::containerStyle
        ProdEnv[Environment Variables<br/>K8s Secrets/ConfigMap]:::configStyle
        App[Python Application<br/>src/main.py]:::appStyle
    end

    subgraph "‚òÅÔ∏è External Services"
        TG[Telegram Bot API<br/>api.telegram.org]:::externalStyle
        OR[OpenRouter API<br/>openrouter.ai]:::externalStyle
    end

    subgraph "üìä Monitoring (Future)"
        Logs[Logging<br/>stdout/stderr]:::monitorStyle
        Metrics[Metrics<br/>Prometheus]:::monitorStyle
        Alerts[Alerts<br/>AlertManager]:::monitorStyle
    end

    Dev --> LocalEnv
    Dev --> UVEnv
    Dev --> Make
    Make --> Ruff
    Make --> Mypy
    Make --> Pytest

    UVEnv --> App
    LocalEnv --> App
    ProdEnv --> App
    Container --> App
    
    App --> TG
    App --> OR
    
    App --> Logs
    Logs -.->|Future| Metrics
    Metrics -.->|Future| Alerts

    classDef devStyle fill:#4ECDC4,stroke:#0A7C74,stroke-width:3px,color:#FFF
    classDef configStyle fill:#FFE66D,stroke:#F4A900,stroke-width:2px,color:#000
    classDef envStyle fill:#95E1D3,stroke:#38A98F,stroke-width:2px,color:#000
    classDef toolStyle fill:#A8DADC,stroke:#457B9D,stroke-width:2px,color:#000
    classDef containerStyle fill:#457B9D,stroke:#1D3557,stroke-width:3px,color:#FFF
    classDef appStyle fill:#E63946,stroke:#A4161A,stroke-width:4px,color:#FFF
    classDef externalStyle fill:#F1FAEE,stroke:#1D3557,stroke-width:2px,color:#000
    classDef monitorStyle fill:#06FFA5,stroke:#02C875,stroke-width:2px,color:#000
```

### –û–∫—Ä—É–∂–µ–Ω–∏—è:
- **Local Development**: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å uv
- **Production**: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ Docker + Kubernetes
- **External Services**: Telegram –∏ OpenRouter API
- **Monitoring**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–µ–∫—É—â–µ–µ) + –º–µ—Ç—Ä–∏–∫–∏ (–±—É–¥—É—â–µ–µ)

---

## 11. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** Data Architect - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏

```mermaid
graph TB
    subgraph "üíæ In-Memory Storage"
        Storage[defaultdict~str, list~<br/>conversations]:::storageStyle
        
        subgraph "üîë Keys Structure"
            Key1["'123456:789012'<br/>chat_id:user_id"]:::keyStyle
            Key2["'111111:222222'<br/>chat_id:user_id"]:::keyStyle
            KeyN["'NNNNNN:MMMMMM'<br/>chat_id:user_id"]:::keyStyle
        end
        
        subgraph "üìù Messages Array #1"
            Msg1_1["role: 'user'<br/>content: '–ü—Ä–∏–≤–µ—Ç!'<br/>timestamp: 1699000001.0"]:::msgStyle
            Msg1_2["role: 'assistant'<br/>content: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!'<br/>timestamp: 1699000002.5"]:::msgStyle
            Msg1_3["role: 'user'<br/>content: 'def foo():...'<br/>timestamp: 1699000010.0"]:::msgStyle
        end
        
        subgraph "üìù Messages Array #2"
            Msg2_1["role: 'user'<br/>content: '–ö–æ–¥...'<br/>timestamp: 1699100001.0"]:::msgStyle
            Msg2_2["role: 'assistant'<br/>content: '–ê–Ω–∞–ª–∏–∑...'<br/>timestamp: 1699100005.0"]:::msgStyle
        end
    end
    
    subgraph "‚öôÔ∏è Operations"
        Add[add_message<br/>–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]:::opStyle
        Get[get_history<br/>–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é]:::opStyle
        Clear[clear_history<br/>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é]:::opStyle
        Stats[get_stats<br/>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]:::opStyle
    end
    
    Storage --> Key1
    Storage --> Key2
    Storage --> KeyN
    
    Key1 --> Msg1_1
    Key1 --> Msg1_2
    Key1 --> Msg1_3
    
    Key2 --> Msg2_1
    Key2 --> Msg2_2
    
    Add --> Storage
    Get --> Storage
    Clear --> Storage
    Stats --> Storage

    classDef storageStyle fill:#FF6B6B,stroke:#C92A2A,stroke-width:4px,color:#FFF
    classDef keyStyle fill:#4DABF7,stroke:#1971C2,stroke-width:3px,color:#FFF
    classDef msgStyle fill:#51CF66,stroke:#2F9E44,stroke-width:2px,color:#000
    classDef opStyle fill:#FFD43B,stroke:#FAB005,stroke-width:2px,color:#000
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:
```python
conversations: defaultdict[str, list[dict[str, Any]]] = {
    "chat_id:user_id": [
        {
            "role": "user",
            "content": "message text",
            "timestamp": 1699000001.0
        },
        ...
    ]
}
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- **In-Memory**: –í—Å–µ –≤ RAM, –Ω–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- **Composite Key**: `chat_id:user_id` –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Timestamp**: –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–ª–∞–¥–∫–∞/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **Auto-Initialize**: defaultdict –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏

---

## 12. CI/CD Pipeline

**–¢–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è:** DevOps - –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

```mermaid
graph LR
    subgraph "üë®‚Äçüíª Developer Workflow"
        Code[üíª Code Changes]:::devStyle
        Branch[üåø Feature Branch]:::devStyle
    end
    
    subgraph "üß™ Local Checks (make ci)"
        Format[üé® make format<br/>ruff format]:::checkStyle
        Lint[üîç make lint<br/>ruff check + mypy]:::checkStyle
        TestUnit[‚úÖ make test-unit<br/>pytest unit tests]:::checkStyle
    end
    
    subgraph "üöÄ CI Server (Future)"
        CILint[üìã Lint Check<br/>ruff + mypy]:::ciStyle
        CITest[üß™ Tests<br/>pytest all]:::ciStyle
        CICov[üìä Coverage<br/>pytest-cov 80%+]:::ciStyle
    end
    
    subgraph "‚úÖ Quality Gates"
        RuffOK{Ruff: 0 errors}:::gateStyle
        MypyOK{Mypy: Success}:::gateStyle
        TestOK{Tests: Pass}:::gateStyle
        CovOK{Coverage: 80%+}:::gateStyle
    end
    
    subgraph "üì¶ Deployment"
        Merge[üîÄ Merge to main]:::deployStyle
        Deploy[üöÄ Deploy to prod]:::deployStyle
    end

    Code --> Branch
    Branch --> Format
    Format --> Lint
    Lint --> RuffOK
    Lint --> MypyOK
    RuffOK --> TestUnit
    MypyOK --> TestUnit
    TestUnit --> TestOK
    
    TestOK -->|Success| CILint
    CILint --> CITest
    CITest --> CICov
    CICov --> CovOK
    
    CovOK -->|Pass| Merge
    Merge --> Deploy
    
    RuffOK -->|Fail| Code
    MypyOK -->|Fail| Code
    TestOK -->|Fail| Code
    CovOK -->|Fail| Code

    classDef devStyle fill:#4ECDC4,stroke:#0A7C74,stroke-width:3px,color:#FFF
    classDef checkStyle fill:#A8DADC,stroke:#457B9D,stroke-width:2px,color:#000
    classDef ciStyle fill:#457B9D,stroke:#1D3557,stroke-width:2px,color:#FFF
    classDef gateStyle fill:#FFD43B,stroke:#FAB005,stroke-width:3px,color:#000
    classDef deployStyle fill:#06FFA5,stroke:#02C875,stroke-width:3px,color:#000
```

### –≠—Ç–∞–ø—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. **Local Checks**: `make ci` –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
   - Ruff format + check (0 errors)
   - Mypy strict mode (100% typed)
   - Unit tests (–Ω–µ —Ç—Ä–µ–±—É—é—Ç .env)

2. **CI Server** (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è):
   - –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
   - Coverage report (—Ü–µ–ª—å: 80%+)

3. **Quality Gates**:
   - Ruff: 0 –æ—à–∏–±–æ–∫ ‚úÖ
   - Mypy: Success ‚úÖ
   - Tests: All pass ‚úÖ
   - Coverage: 81% ‚úÖ

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ KPI

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **Response Time**: 2-10 —Å–µ–∫ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç LLM)
- **Polling Interval**: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é aiogram (–ø—É—à–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
- **Memory Usage**: ~50 MB + –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
- **Timeout**: 60 —Å–µ–∫ –¥–ª—è LLM –∑–∞–ø—Ä–æ—Å–æ–≤

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:
- **Ruff**: 0 –æ—à–∏–±–æ–∫ ‚úÖ
- **Mypy**: 100% —Ç–∏–ø–∏–∑–∞—Ü–∏—è ‚úÖ
- **Test Coverage**: 81% ‚úÖ
- **Lines of Code**: ~700 LOC (–≤–∫–ª—é—á–∞—è —Ç–µ—Å—Ç—ã)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **Modules**: 6 core modules
- **Classes**: 5 main classes
- **Dependencies**: 6 –æ—Å–Ω–æ–≤–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
- **Complexity**: Low (KISS –ø—Ä–∏–Ω—Ü–∏–ø)

---

## üéØ –í—ã–≤–æ–¥—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** (KISS):
   - –ú–∏–Ω–∏–º—É–º –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
   - –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
   - –ü–æ–Ω—è—Ç–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

2. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**:
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (SRP)
   - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - –õ–µ–≥–∫–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

3. **–ì–∏–±–∫–æ—Å—Ç—å**:
   - –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ –ø—Ä–æ–º–ø—Ç—ã
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ .env
   - –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

4. **–ö–∞—á–µ—Å—Ç–≤–æ**:
   - 100% —Ç–∏–ø–∏–∑–∞—Ü–∏—è (mypy strict)
   - 81% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:

1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –î–æ–±–∞–≤–∏—Ç—å –ë–î –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: Redis –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: Prometheus + Grafana –º–µ—Ç—Ä–∏–∫–∏
4. **Deployment**: Docker + Kubernetes
5. **Testing**: –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–æ 95%+

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [README.md](../README.md) - –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [vision.md](./vision.md) - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ
- [idea.md](./idea.md) - –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- [Guides](./guides/README.md) - –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –≥–∞–π–¥–æ–≤ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- [conventions.mdc](../.cursor/rules/conventions.mdc) - –°–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ –∫–æ–¥—É
- [workflow_tdd.mdc](../.cursor/rules/workflow_tdd.mdc) - TDD –ø—Ä–æ—Ü–µ—Å—Å

---

**–°–æ–∑–¥–∞–Ω–æ:** 2025-10-16  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ


